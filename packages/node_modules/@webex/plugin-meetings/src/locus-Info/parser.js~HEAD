import LocusUtil from '../locus-Info/utils';
import {DELTAEVENT, LOCUS} from '../constants';

const Parser = {};

// https://sqbu-github.cisco.com/WebExSquared/cloud-apps/wiki/Locus-Delta-Events
Parser.updateWithDeltaLocus = (deltaLocus, meeting) => {
  if (!(deltaLocus.sequence && (deltaLocus.sequence.rangeStart <= deltaLocus.sequence.rangeEnd) && (deltaLocus.sequence.rangeEnd <= min(deltaLocus.sequence.entries)))) {
    return null;
  }

  // THIS IS A NEW MEETING OBJECT
  // // If meeting has no sequence, it means just initialized and will apply whatever in locus DTO
  // if (isNewMeeting || !this.locus.sequence) {
  //   meeting._updateWithDeltaLocus(deltaLocus, emitter);
  //   meeting.locusDesync = false;
  //   meeting.needToGetFullLocus = false;
  //   return DELTAEVENT.GT;
  // }

  if (!deltaLocus.sequence) {
    // TODO: force update
  }

  // TODO: If this was the first event, the client will not have a syncURL
  // in its working copy to do a GET on. In this case clients should do a GET on locusUrl contained in the DTO

  let res;
  let resBase;
  res = LocusUtil.compareLocus(deltaLocus.sequence, meeting.locus.sequence);
  // In-coming locus is greater than working copy, need to compare with base if there
  // is base sequence except the first delta locus event
  if (res === DELTAEVENT.GT && deltaLocus.baseSequence && meeting.locus.syncUrl) {
    resBase = LocusUtil.compareLocus(deltaLocus.baseSequence, meeting.locus.sequence);
    if (resBase === DELTAEVENT.LT || resBase === DELTAEVENT.CF) {
      res = DELTAEVENT.CF;
    }
  }
  // Special case for OBTP with meeting size equal or over 5. Locus might change this later
  // This is a temporary fix. I will find a better solution later.
  if (!deltaLocus.baseSequence && res === DELTAEVENT.EQ && deltaLocus.fullState.state === 'INITIALIZING'
        && deltaLocus.sequence.rangeStart === 0 && deltaLocus.sequence.rangeEnd === 0
        && deltaLocus.sequence.entries.length === 0) {
    res = DELTAEVENT.GT;
    console.log('Special case for OBTP');
  }

  console.log('RESULT :', res);
  switch (res) {
    case DELTAEVENT.LT:
    case DELTAEVENT.EQ:
      meeting.locusDesync = false;
      meeting.needToGetFullLocus = false;
      break;
    case DELTAEVENT.CF:
      LocusUtil.generateSyncDebugFlag(meeting, deltaLocus);
      if (meeting.locusDesync) {
        meeting.meetingRequest.getFullLocus({
          desync: true,
          locusUrl: meeting.locusUrl
        }).then((res) => {
          meeting.locusInfo.onFullLocus(res.body);
        });
      }
      else {
        meeting.locusDesync = true;
        Parser.syncMeeting(meeting, deltaLocus);
      }
      break;
    case DELTAEVENT.GT:
      console.info('MeetingAmpstate#updateWithDeltaLocus: MeetingConstants.deltaLocusResult.GT');
      meeting.locusInfo.onDeltaLocus(deltaLocus);
      // Turn off desync in case this delta locus comes from a sync request
      meeting.locusDesync = false;
      meeting.needToGetFullLocus = false;
      break;
    default:
  }
  return res;
};


Parser.syncMeeting = (meeting, deltaLocus) => {
  if (meeting
        && meeting.locus
        && meeting.locus.syncUrl
        && meeting.locus.fullState
        && meeting.locus.fullState.state !== LOCUS.STATE.INACTIVE) {
    // found that the locus syncs were happening even after 4 hrs of meeting
    // completion, resulting in 403 errors. This check ensures we call
    // syncing only if the locus state is not INACTIVE.
    meeting.meetingRequest.syncMeeting({
      syncUrl: deltaLocus.syncUrl,
      desync: meeting.desync
    })
      .then((res) => {
        meeting.locusInfo.onDeltaLocus(res.body);
        // Parser.updateMeeting(res.body, meeting);
        console.log(`meeting-adapter#syncMeeting: performing sync for uri: ${meeting.locus.syncUrl} and state: ${meeting.locus.fullState.state}`);
      })
      .catch((err) => {
        console.error('Error syncing the locus', err);
      });
  }
  else if (meeting && meeting.locus && meeting.locus.syncUrl && meeting.locus.fullState) {
    // TODO: remoev this later as meeting object wont be present
    console.error(`meeting-adapter#syncMeeting: skip sync for url: ${meeting.locus.syncUrl} and state: ${meeting.locus.fullState.state}`);
  }
};

export default Parser;
