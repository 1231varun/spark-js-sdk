import SparkPlugin from '@ciscospark/spark-core';
import JSZip from 'jszip';
import saveAs from 'file-saver';
import MimeBuilder from 'emailjs-mime-builder';

/**
 * @class ReportGenerator is used to compile, zip, and save an eDiscovery report to disk.
 *
 * Warning: This file is browser specific. It cannot function in a NodeJS server environment.
 */
const ReportGenerator = SparkPlugin.extend({
  namespace: 'Ediscovery',

  props: {
    reportId: 'string',
    zip: 'object',
    folder: 'object'
  },

  /**
   * Create a new report-generator specific to one report.
   *
   * @param {Object} attrs reportId must be included.
   * @param {Object} options Additional options passed up to the parent.
   * @returns {Object} A report generator object.
   */
  initialize(attrs, options) {
    Reflect.apply(SparkPlugin.prototype.initialize, this, [attrs, options]);

    if (!attrs || !attrs.reportId) {
      throw new Error('Missing Required Argument reportId');
    }

    this.reportId = attrs.reportId;
  },

  /**
   * Map an activity to an MIME rfc822 formated string that can be saved as an eml file.
   * @param {Object} activity An activity object
   * @returns {String} A string that represents the data stored in an eml file.
   */
  map(activity) {
    if (!activity) {
      throw new Error('Invalid activity');
    }

    const mime = new MimeBuilder('multipart/mixed')
      .setHeader('From', activity.actorId)
      .setHeader('To', 'Foo Bar <foo@bar.com>')
      .setHeader('Subject', activity.activityId)
      .setHeader('Date', activity.timestamp);

    mime.createChild('text/plain')
      .setContent(activity.content);

    return mime.build();
  },

  /**
   * Add activities to the report.
   * @param {Object[]} activities Activities that are to form part of the report
   * @returns {Void}
   */
  add(activities) {
    if (!activities || !Array.isArray(activities) || !activities.length) {
      throw new Error('No supplied activities to add');
    }

    if (!this.zip) {
      this.zip = new JSZip();
      this.folder = this.zip.folder(`${this.reportId}/conversation`);
    }

    this.logger.info('Creating Folder Structure');

    for (let i = 0; i < activities.length; i += 1) {
      const activity = activities[i];
      const data = this.map(activity);
      this.folder.file(`${activity.activityId}.eml`, data);
    }
  },

  /**
   * Once all the activities have been added create a report and save it to disk.
   * @returns {Promise} A promise on the generated report
   */
  saveAs() {
    if (!this.zip) {
      throw new Error('No activities added to report');
    }

    this.logger.info('Creating Zip File');
    return this.zip.generateAsync({type: 'blob'})
      .then((content) => {
        // Download to the user's browser
        this.logger.info('Downloading...');
        saveAs(content, `${this.reportId}.zip`);
      });
  }
});

export default ReportGenerator;
