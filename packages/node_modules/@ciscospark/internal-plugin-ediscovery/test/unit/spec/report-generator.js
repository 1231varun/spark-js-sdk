import {assert} from '@ciscospark/test-helper-chai';
import {skipInNode} from '@ciscospark/test-helper-mocha';
import {ReportGenerator} from '@ciscospark/internal-plugin-ediscovery';

import activities from './activities';

describe('report-generator', () => {
  const reportId = 'cc06f622-46ab-45b9-b3a6-5d70bad1d70a';

  let generator;
  beforeEach(() => {
    generator = new ReportGenerator({reportId});
  });

  describe('Initialize With No Report Id', () => {
    it('initializeError', async () => {
      assert.throws(() => new ReportGenerator());
    });
  });

  describe('Mapping', () => {
    it('map', async () => {
      const activity = activities[0];
      const eml = generator.map(activity);
      assert.isTrue(eml.includes(`From: ${activity.actorId}`));
      assert.isTrue(eml.includes(`Subject: ${activity.activityId}`));
      assert.isTrue(eml.includes(`Date: ${activity.timestamp}`));
      assert.isTrue(eml.includes(`${activity.content}`));
    });

    it('emptyActivity', async () => {
      assert.throws(() => generator.map());
    });
  });

  describe('Add Activities to Report Tests', () => {
    it('addActivities', async () => {
      generator.add(activities);

      assert.isOk(generator.zip);
      assert.isOk(generator.folder);
      // Account for 'file' objects that represent folders
      const numberOfFolders = generator.folder.root.split('/').length - 1;
      assert.equal(Object.keys(generator.folder.files).length, activities.length + numberOfFolders);
      // Validate each activity has an associated file in the zip
      for (let i = 0; i < activities.length; i += 1) {
        const activity = activities[i];
        assert.isOk(`${generator.folder.root}${activity.activityId}.eml` in generator.folder.files);
      }
    });

    it('emptyActivities', async () => {
      assert.throws(() => generator.add(undefined));
      assert.throws(() => generator.add([]));
    });
  });

  describe('Save As Tests', () => {
    skipInNode(it)('saveAs', async () => {
      generator.add(activities);
      generator.saveAs(reportId)
        .then(() => assert.isOk(true));
    });

    it('saveAsWithNoAdd', async () => {
      assert.throws(() => generator.saveAs(reportId));
    });
  });
});
